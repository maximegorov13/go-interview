# Runtime/Scheduler

## **Планировщик в Go**

Планировщик — это компонент **рантайма** Go, который отвечает за выполнение и управление горутинами. Он распределяет горутины между потоками ОС (threads), управляет очередями задач и обеспечивает эффективное использование процессоров.

---

### **Принципы работы планировщика**

1. **FIFO (First In First Out)**:
   - Очереди задач (горутины) работают по принципу "первый пришёл — первый ушёл".

2. **Создание минимального числа потоков**:
   - Планировщик создаёт ровно столько потоков, сколько ядер у процессора.
   - Он избегает избыточного количества потоков для оптимизации производительности.

3. **Управление потоками ОС**:
   - Планировщик работает поверх потоков операционной системы.
   - Он связывает горутины с системными потоками, чтобы эффективно использовать ресурсы.

---

### **Основные компоненты планировщика**

1. **Локальная очередь (LRQ)**:
   - Одна очередь на каждый **P (Processor)**.
   - Хранит до 256 горутин.
   - Работает по принципу FIFO.

2. **Глобальная очередь (GRQ)**:
   - Одна очередь на всё приложение.
   - Используется, если локальная очередь переполнена или пуста.
   - FIFO-принцип для распределения задач.

3. **Сетевой поллер (Net Poller)**:
   - Обрабатывает горутины, ожидающие завершения сетевых операций.
   - Например, чтение данных из сокетов или с диска.

4. **Очередь таймеров**:
   - Управляет горутинами, ожидающими завершения таймеров (`time.Sleep`, `time.After`).

5. **Очередь судьбы (RunNext)**:
   - Слот приоритетной горутины на каждом **P**.
   - Используется для выполнения срочных задач.

---

### **Как планировщик обрабатывает задачи?**

1. **Порядок проверки очередей**:
   - Сначала проверяется локальная очередь (LRQ).
   - Если она пуста, горутины берутся из глобальной очереди (GRQ).
   - Если задачи отсутствуют в обеих очередях, поток ОС может простаивать.

2. **Переключение задач (stealing)**:
   - Если одна локальная очередь пуста, планировщик может забрать задачи из другой локальной очереди или из глобальной.

3. **Работа с блокирующими операциями**:
   - Если горутина блокируется, например, ожидая ответа ОС (чтение файла или сокета), поток ОС также блокируется. Это снижает эффективность, так как другие горутины в очереди остаются незавершёнными.
   - Планировщик перераспределяет горутины между другими потоками для продолжения работы.

---

### **Особенности очередей**

- Локальные очереди приоритетны, так как доступ к ним быстрее.
- Глобальная очередь используется для перераспределения задач между процессорами.

---

### **Вытесняющая многозадачность**

1. **Работа тредов ОС**:
   - Операционная система выделяет каждому треду временное окно для выполнения (time slice).
   - Если поток не завершает работу за это время, происходит **контекстное переключение (context switch)**.

2. **Контекстное переключение**:
   - Планировщик ОС замещает один поток другим, сохраняя состояние текущего.
   - Это добавляет накладные расходы, но позволяет эффективно делить процессорное время между задачами.

---

## **Рантайм в Go**

Рантайм — это вся инфраструктура, обеспечивающая выполнение программы Go. Он включает в себя планировщик, сборщик мусора, аллокатор памяти и другие системные компоненты.

---

### **Основные компоненты рантайма**

1. **Планировщик (Scheduler)**:
   - Управляет горутинами и их выполнением.

2. **Сборщик мусора (Garbage Collector)**:
   - Удаляет неиспользуемые объекты из памяти.
   - Работает параллельно с горутинами, чтобы минимизировать паузы в работе программы.

3. **Аллокатор памяти (Memory Allocator)**:
   - Выделяет память для объектов в куче или стеке.
   - Использует **Escape Analysis** для определения, где должен размещаться объект.

4. **Система стека**:
   - Каждый стек горутины начинается с маленького размера и увеличивается по мере необходимости.
   - Это помогает оптимизировать использование памяти.

---

### **Работа рантайма с памятью**

1. **Стек**:
   - Используется для локальных переменных.
   - Быстрый доступ, так как стек выделяется блоками.
   - Стек каждой горутины изолирован и управляется автоматически.

2. **Куча**:
   - Используется для динамически выделенных объектов (слайсы, мапы, строки, каналы).
   - Управляется сборщиком мусора.
   - Доступ к памяти медленнее, чем к стеку, так как объекты размещаются в разных частях памяти.

---

### **Escape Analysis**

- Компилятор анализирует, где должна размещаться переменная.
- Если переменная доступна только внутри функции, она размещается в стеке.
- Если переменная "убегает" за пределы функции (например, возвращается по указателю), она размещается в куче.

---

## **Преимущества планировщика и рантайма Go**

1. **Высокая производительность**:
   - Управление тысячами горутин с минимальными затратами ресурсов.
   - Автоматическое распределение задач между процессорами.

2. **Безопасность**:
   - Потокобезопасный обмен данными через каналы.
   - Сборщик мусора автоматически освобождает неиспользуемую память.

3. **Простота разработки**:
   - Автоматическое управление стеками.
   - Разработчик не управляет потоками ОС напрямую.
