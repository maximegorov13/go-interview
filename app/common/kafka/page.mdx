# Kafka

## Что такое Apache Kafka?

Apache Kafka — это распределённая платформа обработки потоков данных с открытым исходным кодом. Она используется для передачи, хранения и обработки событий в режиме реального времени.

**Основные характеристики Kafka:**

- Высокая производительность: способна обрабатывать миллионы сообщений в секунду.
- Надёжность: сообщения сохраняются на диск и могут быть воспроизведены.
- Масштабируемость: легко масштабируется за счёт использования партиций.
- Асинхронность: обеспечивает взаимодействие между системами без необходимости в синхронной обработке запросов.

## Основные компоненты Kafka

1. **Продюсер (Producer):**
   - Компонент, отправляющий сообщения в Kafka.
   - Отправляет данные в определённые топики.
   - Используется для записи логов, передачи данных между микросервисами и других сценариев.

2. **Консьюмер (Consumer):**
   - Компонент, получающий сообщения из Kafka.
   - Может быть подписан на один или несколько топиков.
   - Используется для анализа данных, обработки событий, интеграции с внешними системами.

3. **Топики (Topics):**
   - Логическое объединение сообщений, относящихся к одной тематике.
   - Сообщения внутри топика хранятся в партициях.
   - Пример: топик "orders" для обработки заказов.

4. **Партиции (Partitions):**
   - Единица хранения данных в Kafka, которая разделяет топик на более мелкие логические сегменты.
   - Партиции обеспечивают параллельную обработку сообщений.
   - Каждая партиция имеет лидера, который обрабатывает запросы на запись и чтение.

5. **Брокеры (Brokers):**
   - Серверы, которые запускают Kafka и хранят данные топиков.
   - Каждый брокер обрабатывает одну или несколько партиций.

6. **Offset:**
   - Порядковый номер сообщения внутри партиции.
   - Используется для отслеживания позиции чтения консьюмером.

7. **Группа консьюмеров (Consumer Group):**
   - Логическая группа консьюмеров, совместно обрабатывающая сообщения.
   - Каждой партиции назначается один консьюмер из группы.

## Механизмы доставки сообщений в Kafka

1. **At most once (максимум один раз):**
   - Сообщение может быть потеряно, но никогда не будет доставлено повторно.
   - Подходит для сценариев, где производительность важнее, чем точность.

2. **At least once (как минимум один раз):**
   - Сообщение гарантированно будет доставлено, но может быть дублировано.
   - Является настройкой по умолчанию в Kafka.

3. **Exactly once (ровно один раз):**
   - Каждое сообщение доставляется строго один раз.
   - Требует дополнительной настройки (например, идемпотентных продюсеров и транзакций).

4. **Effectively once (эффективно один раз):**
   - Гарантирует, что результат обработки сообщения будет применён только один раз, даже если само сообщение может быть доставлено несколько раз.

## Паттерны использования Kafka

1. **Outbox Pattern (Аутбокс-паттерн):**
   - Обеспечивает атомарность между изменением базы данных и отправкой сообщения.
   - Сообщения временно записываются в таблицу outbox, а затем передаются в Kafka.

**Преимущества:**

- Обеспечивает надёжную доставку сообщений.
- Исключает риск несоответствия данных между базой данных и Kafka.

2. **Inbox Pattern (Инбокс-паттерн):**
   - Используется для предотвращения повторной обработки сообщений.
   - Сообщения сначала сохраняются в таблицу inbox, чтобы проверить, не было ли они обработаны ранее.

**Преимущества:**

- Исключает дублирующую обработку.
- Обеспечивает устойчивость к сбоям.

**Комбинация этих паттернов позволяет добиться семантики "exactly-once".**

## Kafka vs RabbitMQ

| **Параметр**      | **Kafka**                     | **RabbitMQ**                         |
| ----------------- | ----------------------------- | ------------------------------------ |
| **Скорость**      | Медленнее, пишет на диск.     | Быстрее, пишет в оперативную память. |
| **Надёжность**    | Высокая, сохраняет сообщения. | Требует настройки для сохранения.    |
| **Использование** | Потоковая обработка данных.   | Традиционная очередь сообщений.      |

## Когда использовать Kafka?

- Если производитель (продюсер) отправляет сообщения быстрее, чем их может обработать потребитель (консьюмер).
- Для асинхронного взаимодействия между системами.
- Если требуется надёжное хранение и возможность повторной обработки сообщений.

## Ключевые вопросы

### Что такое Kafka и для чего она используется?

Kafka — это система обмена сообщениями, используемая для передачи, хранения и обработки данных в режиме реального времени. Она применяется в сценариях потоковой обработки данных, интеграции систем и асинхронного взаимодействия между микросервисами.

### Что такое топик и партиция в Kafka?

- Топик — это логическое объединение сообщений.
- Партиция — это физическое разделение топика для обеспечения параллелизма и масштабируемости.

### Чем отличается `At least once` от `Exactly once`?

- `At least once`: сообщение гарантированно будет доставлено, но возможно дублирование.
- `Exactly once`: сообщение будет доставлено ровно один раз, исключая дублирование.

### Что такое offset в Kafka?

Offset — это уникальный идентификатор сообщения внутри партиции, используемый для отслеживания прогресса чтения.

### Как Kafka обеспечивает надёжность доставки сообщений?

- Сохраняет данные на диск.
- Использует репликацию данных между брокерами.
- Обеспечивает семантики доставки (`At least once`, `Exactly once`).

### Как распределяется нагрузка между консьюмерами?

Каждой партиции назначается один консьюмер из группы консьюмеров. Это обеспечивает параллельную обработку данных.

### Чем Kafka отличается от традиционных брокеров сообщений?

- Kafka сохраняет все сообщения на диск и позволяет повторное чтение.
- Поддерживает высокую производительность и масштабируемость.
- Подходит для потоковой обработки данных в реальном времени.
