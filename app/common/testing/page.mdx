# Тестирование

## Что такое тестирование?

Тестирование в Go позволяет проверять работоспособность и корректность кода с использованием встроенного пакета **`testing`** и сторонних библиотек. Оно включает тестирование отдельных компонентов (юнит-тесты), взаимодействия между ними (интеграционные тесты), а также производительности (бенчмарки).

## Основные инструменты тестирования в Go

1. **Встроенный пакет `testing`:**
   - Предназначен для написания юнит-тестов, интеграционных тестов и бенчмарков.
   - Позволяет создавать тестовые функции, которые именуются с префиксом `Test` (например, `TestFunctionName`).
2. **Библиотека `testify`:**
   - Упрощает написание тестов, предоставляя такие функции, как `assert` и `require` для проверки условий.
   - Делает тесты более читаемыми.
3. **Моки (Mocking):**
   - Для изоляции тестируемого компонента от внешних зависимостей используется библиотека **`gomock`**.
   - Позволяет создавать фиктивные реализации интерфейсов, чтобы проверить, как код взаимодействует с ними.

## Виды тестов в Go

### 1. Юнит-тесты

- **Определение:** Проверяют отдельные функции или методы в изоляции от других компонентов.
- **Особенности:**
  - Проверяют только логику тестируемой функции.
  - Внешние зависимости заменяются моками.

**Преимущества:**

- Легко писать и поддерживать.
- Быстро выполняются.
- Выявляют ошибки на ранних стадиях разработки.

### 2. Интеграционные тесты

- **Определение:** Проверяют взаимодействие между разными компонентами программы.
- **Особенности:**
  - Проверяют, как компоненты или сервисы работают вместе.
  - Часто тестируют "сквозной" процесс через несколько уровней приложения.

**Примеры:**

- Проверка взаимодействия HTTP-обработчиков с базой данных через мок-объекты.
- Тестирование API-серверов с имитацией запросов и ответов.

**Преимущества:**

- Убеждают, что компоненты работают корректно вместе.
- Помогают выявить ошибки в интеграции.

**Недостатки:**

- Выполняются медленнее, чем юнит-тесты.
- Сложнее писать и поддерживать.

### 3. Автотесты

- **Определение:** Тесты, которые автоматически запускаются при изменении кода.
- **Особенности:**
  - Автоматизируют процесс проверки изменений.
  - Используются для обеспечения стабильности кода.

**Инструменты:**

- Go предоставляет возможность автоматического запуска тестов с помощью `go test`.
- Интеграция с CI/CD (например, GitHub Actions, GitLab CI) позволяет запускать тесты на каждом этапе разработки.

### 4. Бенчмарки

- **Определение:** Тесты производительности, которые измеряют, как быстро выполняется код.
- **Особенности:**
  - Пишутся с использованием `func BenchmarkXxx(b *testing.B)`.
  - Используются для оптимизации кода, например, при работе с парсингом JSON, обработкой данных или сетевыми запросами.

## Профилирование кода

- **Определение:** Процесс анализа кода для выявления "узких мест" в производительности.
- **Инструменты:**
  - **`pprof`:** Встроенный инструмент для профилирования CPU, памяти и задержек.
  - Позволяет анализировать производительность и улучшать эффективность кода.

## Тестовые наборы (Test Suites)

- **Определение:** Наборы тестов, объединённые по какому-либо признаку (например, функциональность, модуль).
- **Цель:** Группировка тестов для упрощения запуска и анализа.
- **Инструменты:**
  - Использование библиотек, таких как `testify`, для объединения тестов в тестовые наборы.

## Тестирование ошибок

- **Проверка ошибок:**
  - Используйте подход `if err != nil` для обработки ошибок в тестах.
  - Проверяйте корректность возвращаемых ошибок и их типов.
- **Обёртывание и разворачивание ошибок:**
  - Проверяйте ошибки с использованием `errors.Is` и `errors.As`.

## Лучшие практики тестирования в Go

1. **Покрытие тестами:**
   - Стремитесь к покрытию кода тестами не менее 70–80%.
   - Покрывайте основную бизнес-логику.
2. **Юнит-тесты для логики:**
   - Покрывайте отдельные функции/методы юнит-тестами.
   - Используйте моки для изоляции тестируемого компонента.
3. **Интеграционные тесты для взаимодействия:**
   - Тестируйте взаимодействие компонентов через моки или реальные интеграции.
4. **Пишите бенчмарки:**
   - Для проверки производительности алгоритмов или работы с большими данными.
5. **Автоматизация:**
   - Используйте инструменты CI/CD для автоматического запуска тестов.
   - Настройте запуск тестов при каждом коммите.
6. **Используйте моки:**
   - Для имитации внешних сервисов и зависимостей.
   - Это снижает сложность тестов и ускоряет их выполнение.
7. **Пишите читаемые тесты:**
   - Используйте библиотеку `testify` для удобного написания и проверки условий.
   - Структурируйте тесты, чтобы их было легко читать и поддерживать.

## Заключение

| **Тип теста**            | **Цель**                                                      |
| ------------------------ | ------------------------------------------------------------- |
| **Юнит-тесты**           | Проверка отдельных функций/методов.                           |
| **Интеграционные тесты** | Проверка взаимодействия между компонентами.                   |
| **Бенчмарки**            | Оптимизация производительности кода.                          |
| **Автотесты**            | Обеспечение стабильности и автоматическая проверка изменений. |

Go предоставляет мощные инструменты для тестирования, которые позволяют разрабатывать надёжное и масштабируемое программное обеспечение. Следование лучшим практикам, использование встроенных пакетов и сторонних библиотек, таких как `testify` и `gomock`, значительно упрощают процесс тестирования.
