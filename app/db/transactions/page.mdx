# Транзакции

Транзакции в базах данных — это важная концепция, обеспечивающая целостность и согласованность данных при выполнении операций, особенно в условиях многопользовательского доступа или сбоев системы.

## Что такое транзакция?

Транзакция — это последовательность операций, выполняемых как единое целое, так, что либо все они успешно завершаются, либо ни одна из них не оказывает влияния на данные.

## Свойства транзакций: ACID

Транзакции в современных СУБД (например, PostgreSQL, MySQL, Oracle) строго следуют ACID-свойствам:

### 1. Atomicity (Атомарность)

Все операции внутри транзакции рассматриваются как **одна неделимая операция**. Если хотя бы одна из них завершится с ошибкой, вся транзакция откатывается (`rollback`), и изменения не применяются.

**Пример:**

Перевод денег между двумя счетами — сначала списываем с одного, затем добавляем на другой. Если вторая операция не выполнится, то и первая не должна повлиять на данные.

---

### 2. Consistency (Согласованность)

Транзакция переводит базу данных из одного **согласованного состояния** в другое. Все ограничения (`constraints`), триггеры, правила и т.п. должны быть соблюдены.

**Пример:**

Если в таблице есть ограничение, что поле `balance` не может быть отрицательным, транзакция не должна нарушать это правило.

---

### 3. Isolation (Изолированность)

Транзакции изолированы друг от друга. Результаты одной транзакции не должны быть видны другим, пока она не завершена.

**Пример:**

Если два пользователя одновременно пытаются списать деньги с одного счёта, изоляция гарантирует, что одна транзакция не повлияет на другую.

#### Уровни изоляции:

- `READ UNCOMMITTED`
- `READ COMMITTED`
- `REPEATABLE READ`
- `SERIALIZABLE`

---

### 4. Durability (Долговечность)

После успешного завершения (`commit`) изменения, внесённые транзакцией, сохраняются в БД навсегда, даже если произойдёт сбой (например, отключение питания).

## ACID кратко

| Понятие         | Описание                                                     |
| --------------- | ------------------------------------------------------------ |
| Транзакция      | Последовательность операций, выполняемых как единое целое    |
| ACID            | Атомарность, Согласованность, Изолированность, Долговечность |
| BEGIN/COMMIT    | Начало и фиксация транзакции                                 |
| ROLLBACK        | Откат изменений при ошибке                                   |
| Уровни изоляции | Определяют, насколько транзакции изолированы друг от друга   |

## Синтаксис транзакций в PostgreSQL

```sql
BEGIN; -- или BEGIN TRANSACTION;

-- SQL-операции
UPDATE accounts SET balance = balance - 100 WHERE id = 1;
UPDATE accounts SET balance = balance + 100 WHERE id = 2;

COMMIT; -- сохранить изменения
-- ROLLBACK; -- откатить изменения
```

## Уровни изоляции в PostgreSQL

| Уровень            | Описание                                                                |
| ------------------ | ----------------------------------------------------------------------- |
| `READ UNCOMMITTED` | Не поддерживается (автоматически становится `READ COMMITTED`)           |
| `READ COMMITTED`   | Читает только зафиксированные данные.                                   |
| `REPEATABLE READ`  | Предотвращает "неповторяющееся чтение", но возможны "фантомные чтения". |
| `SERIALIZABLE`     | Наивысший уровень изоляции, полностью исключает аномалии.               |

### Пример установки уровня изоляции:

```sql
BEGIN ISOLATION LEVEL SERIALIZABLE;
-- или
SET TRANSACTION ISOLATION LEVEL REPEATABLE READ;
```

## Примеры транзакций в PostgreSQL

### Пример 1: Перевод средств

```sql
BEGIN;

UPDATE accounts SET balance = balance - 100 WHERE id = 1;
UPDATE accounts SET balance = balance + 100 WHERE id = 2;

COMMIT;
```

Если в процессе выполнения произойдёт ошибка, изменения не будут применены.

### Пример 2: Откат транзакции

```sql
BEGIN;

UPDATE accounts SET balance = balance - 500 WHERE id = 1;

-- Если баланс < 0, транзакция откатывается
DO $$
BEGIN
    IF (SELECT balance FROM accounts WHERE id = 1) < 0 THEN
        RAISE EXCEPTION 'Insufficient funds';
    END IF;
END $$;

COMMIT; -- или ROLLBACK;
```

### Пример 3: Сохранение точки сохранения (savepoint)

```sql
BEGIN;

UPDATE accounts SET balance = balance - 100 WHERE id = 1;
SAVEPOINT sp1;

UPDATE accounts SET balance = balance + 100 WHERE id = 2;

-- Что-то пошло не так — откат до точки
ROLLBACK TO sp1;

COMMIT;
```

## Транзакции и конкурентный доступ

PostgreSQL использует **MVCC** (Multi-Version Concurrency Control) — механизм, позволяющий читателям не блокировать писателей и наоборот. Это делает транзакции более эффективными при высокой нагрузке.

## Краткий конспект по PostgreSQL

| Команда                               | Описание                  |
| ------------------------------------- | ------------------------- |
| `BEGIN` / `START TRANSACTION`         | Начало транзакции         |
| `COMMIT`                              | Фиксация изменений        |
| `ROLLBACK`                            | Откат изменений           |
| `SAVEPOINT`                           | Создание точки сохранения |
| `ROLLBACK TO savepoint`               | Откат до точки            |
| `SET TRANSACTION ISOLATION LEVEL ...` | Установка уровня изоляции |

---

### Советы и особенности

- PostgreSQL по умолчанию использует уровень изоляции `READ COMMITTED`.
- Уровень `SERIALIZABLE` может привести к `Serialization Failure`, особенно при высокой нагрузке.
- Всегда используйте транзакции при выполнении **связанных операций**.
- Транзакции не рекомендуется использовать в долгих операциях, т.к. могут блокировать ресурсы.
